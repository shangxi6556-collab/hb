<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>币安红包 - 每小时抢 BNB</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>
  <style>
    body { margin:0; font-family: 'Microsoft YaHei'; background: linear-gradient(135deg, #667eea, #764ba2); color:white; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .box { background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); padding:40px; border-radius:25px; width:90%; max-width:500px; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    h1 { margin:0 0 20px; font-size:28px; }
    .info { font-size:18px; margin:15px 0; }
    .timer { font-size:48px; font-weight:bold; color:#ffeb3b; margin:30px 0; text-shadow:0 0 10px #ffeb3b; }
    button { width:100%; padding:18px; padding:16px; font-size:22px; background:#e74c3c; border:none; border-radius:50px; color:white; cursor:pointer; margin:10px 0; transition:0.3s; }
    button:hover { background:#c0392b; transform:scale(1.05); }
    button:disabled { background:#666; cursor:not-allowed; }
    .rank { margin-top:30px; }
    .rank-item { padding:10px; background:rgba(255,255,255,0.1); margin:5px 0; border-radius:10px; }
  </style>
</head>
<body>
  <div class="box">
    <h1>币安红包 BNBRED</h1>
    <div id="status" class="info">点击连接钱包</div>
    
    <div class="timer" id="timer">00:00:00</div>
    
    <div class="info">本轮红包总额：<b id="amount">0</b> BNB</div>
    <div class="info">剩余名额：<b id="slots">0</b> 个</div>
    
    <button id="connectBtn">连接 MetaMask</button>
    <button id="claimBtn" disabled>立即抢红包</button>

    <div class="rank">
      <h3>本轮手气王排行</h3>
      <div id="ranking">暂无记录</div>
    </div>
  </div>

  <script>
    // ←←←← 唯一要改的地方：填你部署的红包池地址 ←←←←
    const POOL_ADDRESS = "0x你的红包池地址";   // ← 改这里！！！

    const ABI = [
      "function currentRound() view returns (uint256)",
      "function roundStartTime() view returns (uint256)",
      "function remainingSlots() view returns (uint256)",
      "function remainingAmount() view returns (uint256)",
      "function claim()",
      "event Claimed(address indexed user, uint256 amount, uint256 round)"
    ];

    let provider, signer, contract, account;
    let ranking = [];

    // 连接钱包
    async function connect() {
      if (!window.ethereum) return alert("请安装 MetaMask");
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      account = await signer.getAddress();
      contract = new ethers.Contract(POOL_ADDRESS, ABI, signer);

      document.getElementById("status").innerHTML = `已连接: ${account.slice(0,6)}...${account.slice(-4)}`;
      document.getElementById("connectBtn").disabled = true;
      updateAll();
      setInterval(updateAll, 3000);
    }

    // 抢红包
    async function claim() {
      document.getElementById("claimBtn").disabled = true;
      try {
        const tx = await contract.claim();
        await tx.wait();
        alert("恭喜！BNB 已到账钱包！");
        updateAll();
      } catch (e) {
        alert("抢红包失败：" + (e.reason || e.message));
        document.getElementById("claimBtn").disabled = false;
      }
    }

    // 更新所有数据 + 倒计时
    async function updateAll() {
      if (!contract) return;

      const block = await provider.getBlock("latest");
      const now = block.timestamp;

      const startTime = await contract.roundStartTime();
      const timeLeft = 3600 - ((now - startTime) % 3600);
      if (timeLeft < 0) timeLeft = 0;

      const h = String(Math.floor(timeLeft / 3600)).padStart(2,'0');
      const m = String(Math.floor((timeLeft % 3600)/60)).padStart(2,'0');
      const s = String(timeLeft % 60).padStart(2,'0');
      document.getElementById("timer").textContent = `${h}:${m}:${s}`;

      const balance = await provider.getBalance(POOL_ADDRESS);
      document.getElementById("amount").textContent = ethers.formatEther(balance);

      const slots = await contract.remainingSlots();
      document.getElementById("slots").textContent = slots.toString();

      document.getElementById("claimBtn").disabled = slots == 0;
    }

    // 监听抢红包事件（实时更新手气王）
    if (contract) {
      contract.on("Claimed", (user, amount, round) => {
        const bnb = ethers.formatEther(amount);
        ranking.unshift(`${user.slice(0,6)}...${user.slice(-4)} 抢到 ${bnb} BNB`);
        if (ranking.length > 10) ranking.pop();
        document.getElementById("ranking").innerHTML = ranking.map(r => `<div class="rank-item">${r}</div>`).join('');
      });
    }

    document.getElementById("connectBtn").onclick = connect;
    document.getElementById("claimBtn").onclick = claim;
  </script>
</body>
</html>